# Alertmanager Configuration for WeatherInsight

global:
  resolve_timeout: 5m
  
  # SMTP configuration for email alerts
  smtp_smarthost: 'localhost:25'
  smtp_from: 'alertmanager@weatherinsight.local'
  smtp_require_tls: false

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Route configuration
route:
  # Default receiver
  receiver: 'weatherinsight-team'
  
  # Group alerts by cluster, alertname, and service
  group_by: ['cluster', 'alertname', 'service']
  
  # Wait before sending notification for new alert group
  group_wait: 30s
  
  # Wait before sending notification about new alerts for existing group
  group_interval: 5m
  
  # Wait before resending notification
  repeat_interval: 4h
  
  # Child routes
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'weatherinsight-critical'
      group_wait: 10s
      repeat_interval: 1h
      
    # Warning alerts - batched
    - match:
        severity: warning
      receiver: 'weatherinsight-team'
      group_wait: 1m
      repeat_interval: 4h
      
    # Info alerts - daily digest
    - match:
        severity: info
      receiver: 'weatherinsight-team'
      group_wait: 5m
      repeat_interval: 24h

# Inhibition rules - suppress certain alerts when others are firing
inhibit_rules:
  # Suppress warning alerts if critical alert is firing for same service
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ['service', 'cluster']
  
  # Suppress API errors if API is down
  - source_match:
      alertname: APIDown
    target_match_re:
      alertname: ^API.*
    equal: ['service']
  
  # Suppress database alerts if API is down (may be related)
  - source_match:
      alertname: APIDown
    target_match:
      service: postgres
    equal: ['cluster']

# Receiver configurations
receivers:
  # Default team receiver - email
  - name: 'weatherinsight-team'
    email_configs:
      - to: 'team@weatherinsight.local'
        headers:
          Subject: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] WeatherInsight Alert'
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; }
              .alert { padding: 10px; margin: 10px 0; border-left: 4px solid; }
              .critical { border-color: #d32f2f; background-color: #ffebee; }
              .warning { border-color: #f57c00; background-color: #fff3e0; }
              .info { border-color: #0288d1; background-color: #e1f5fe; }
            </style>
          </head>
          <body>
            <h2>{{ .CommonLabels.alertname }}</h2>
            <p><strong>Cluster:</strong> {{ .CommonLabels.cluster }}</p>
            <p><strong>Service:</strong> {{ .CommonLabels.service }}</p>
            <p><strong>Status:</strong> {{ .Status }}</p>
            <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
            
            {{ range .Alerts }}
            <div class="alert {{ .Labels.severity }}">
              <h3>{{ .Annotations.summary }}</h3>
              <p>{{ .Annotations.description }}</p>
              <p><small>Started: {{ .StartsAt }}</small></p>
            </div>
            {{ end }}
          </body>
          </html>
  
  # Critical alerts - email + webhook (could be PagerDuty/Slack)
  - name: 'weatherinsight-critical'
    email_configs:
      - to: 'oncall@weatherinsight.local'
        headers:
          Subject: 'ðŸš¨ [CRITICAL] WeatherInsight Alert - {{ .CommonLabels.alertname }}'
        send_resolved: true
    # Uncomment and configure for Slack integration
    # slack_configs:
    #   - api_url: 'YOUR_SLACK_WEBHOOK_URL'
    #     channel: '#weatherinsight-alerts'
    #     title: '{{ .CommonLabels.alertname }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    #     color: 'danger'
    # Uncomment and configure for PagerDuty integration
    # pagerduty_configs:
    #   - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
    #     description: '{{ .CommonLabels.alertname }}: {{ .CommonAnnotations.summary }}'

  # Null receiver for silenced alerts
  - name: 'null'
