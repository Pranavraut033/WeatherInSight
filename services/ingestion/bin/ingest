#!/usr/bin/env python3
"""CLI entry point for ingestion service."""
import argparse
import logging
import sys
from pathlib import Path

# Add project root to Python path so "src" is a package
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.config import IngestionConfig
from src.orchestrator import IngestionOrchestrator

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


def main():
    """Main CLI entry point."""
    parser = argparse.ArgumentParser(description='WeatherInsight Ingestion Service')
    
    parser.add_argument(
        '--variable',
        type=str,
        help='Variable to ingest (e.g., air_temperature, precipitation, wind)',
    )
    
    parser.add_argument(
        '--all',
        action='store_true',
        help='Ingest all variables',
    )
    
    parser.add_argument(
        '--station-ids',
        nargs='+',
        help='Specific station IDs to ingest (space-separated)',
    )
    
    parser.add_argument(
        '--no-skip-existing',
        action='store_true',
        help='Re-download and upload files even if they exist in MinIO',
    )
    
    parser.add_argument(
        '--recent',
        action='store_true',
        help='Ingest recent data instead of historical',
    )
    
    args = parser.parse_args()
    
    # Validate arguments
    if not args.variable and not args.all:
        parser.error("Either --variable or --all must be specified")
    
    if args.variable and args.all:
        parser.error("Cannot specify both --variable and --all")
    
    try:
        # Load configuration
        config = IngestionConfig.from_env()
        
        # Create orchestrator
        orchestrator = IngestionOrchestrator(config)
        
        # Run ingestion
        if args.all:
            logger.info("Starting ingestion for all variables")
            results = orchestrator.ingest_all_variables(
                station_ids=args.station_ids,
                skip_existing=not args.no_skip_existing,
            )
            
            # Print summary
            print("\n=== Ingestion Summary ===")
            for variable, stats in results.items():
                if 'error' in stats:
                    print(f"{variable}: FAILED - {stats['error']}")
                else:
                    print(f"{variable}: Processed={stats['processed']}, "
                          f"Skipped={stats['skipped']}, Failed={stats['failed']}, "
                          f"Size={stats['total_bytes']/1024/1024:.2f}MB")
        
        else:
            logger.info(f"Starting ingestion for variable: {args.variable}")
            stats = orchestrator.ingest_variable(
                variable=args.variable,
                station_ids=args.station_ids,
                recent=args.recent,
                skip_existing=not args.no_skip_existing,
            )
            
            # Print summary
            print("\n=== Ingestion Summary ===")
            print(f"Variable: {args.variable}")
            print(f"Stations processed: {stats['processed']}")
            print(f"Stations skipped: {stats['skipped']}")
            print(f"Stations failed: {stats['failed']}")
            print(f"Total size: {stats['total_bytes']/1024/1024:.2f} MB")
        
        # Close connections
        orchestrator.close()
        
        logger.info("Ingestion completed successfully")
        return 0
        
    except Exception as e:
        logger.error(f"Ingestion failed: {e}", exc_info=True)
        return 1


if __name__ == "__main__":
    sys.exit(main())
